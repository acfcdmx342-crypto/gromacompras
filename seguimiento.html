<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seguimiento de Solicitudes</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body { background: #eef1f5; }
    .card { border-radius: 20px; }
    .table thead { background:#0d6efd; color:white; }
    .action-btn { cursor:pointer; font-size:22px; margin-right:10px; }

    /* COLORES AUTOM√ÅTICOS */
    .status-compras { background:#0d6efd !important; color:white !important; }
    .status-zona { background:#ffc107 !important; color:#000 !important; }
    .status-pendiente { background:#dc3545 !important; color:white !important; }
    .status-sistemas { background:#198754 !important; color:white !important; }
</style>

</head>
<body class="p-4">

<div class="container">
    <h2 class="fw-bold text-center mb-4">Seguimiento de Solicitudes</h2>

    <div class="text-end mb-3">
        <a href="tecnologia.html" class="btn btn-dark">Ir a Tecnolog√≠a</a>
    </div>

    <div class="card shadow p-4 mb-4">
        <h4 class="fw-bold mb-3">Registrar Seguimiento</h4>

        <form id="formSeg" class="row g-3">

            <div class="col-md-3">
                <label class="form-label fw-bold">Folio</label>
                <select id="folio" class="form-select"></select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Solicit√≥</label>
                <input id="solicito" class="form-control" readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Sucursal</label>
                <input id="sucursal" class="form-control" readonly>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Archivo</label>
                <button type="button" class="btn btn-secondary w-100" onclick="verArchivo()" id="btnArchivo" disabled>Ver Archivo</button>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Fecha Solicitud a Compras</label>
                <input id="fechaCompras" class="form-control" readonly>
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold">Descripci√≥n del Art√≠culo</label>
                <input id="descripcion" class="form-control text-uppercase">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Folio de Cotizaci√≥n</label>
                <input id="folioCot" class="form-control text-uppercase">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Fecha de Cotizaci√≥n</label>
                <input id="fechaCot" type="date" class="form-control">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Quien Autoriza</label>
                <input id="autoriza" class="form-control text-uppercase">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Fecha Autorizaci√≥n</label>
                <input id="fechaAuto" type="date" class="form-control">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Quien Recibe</label>
                <input id="recibe" class="form-control text-uppercase">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Fecha de Entrega</label>
                <input id="fechaEntrega" type="date" class="form-control">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Quien Env√≠a</label>
                <input id="envia" class="form-control text-uppercase">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Fecha Env√≠o</label>
                <input id="fechaEnvio" type="date" class="form-control">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Folio Factura</label>
                <input id="folioFactura" class="form-control text-uppercase">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Status</label>
                <select id="status" class="form-select">
                    <option>ENVIADO A COMPRAS</option>
                    <option>ENVIADO A ZONA</option>
                    <option>PENDIENTE POR AUTORIZAR</option>
                    <option>EN SISTEMAS</option>
                </select>
            </div>

            <div class="col-12">
                <label class="form-label fw-bold">Comentarios</label>
                <textarea id="comentarios" class="form-control text-uppercase"></textarea>
            </div>

            <div class="col-12 mt-3">
                <button type="button" class="btn btn-primary btn-lg" onclick="guardarSeguimiento()">Guardar Seguimiento</button>
            </div>

        </form>
    </div>

    <div class="card shadow p-4">
        <h4 class="fw-bold mb-3">Tabla de Seguimiento</h4>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Folio</th>
                    <th>Solicit√≥</th>
                    <th>Descripci√≥n</th>
                    <th>Folio Cot.</th>
                    <th>Status</th>
                    <th>Fecha Compras</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaSegBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalComent">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Agregar Comentarios</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <textarea id="extraComentario" class="form-control text-uppercase" rows="4"></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-primary" onclick="guardarComentarioExtra()">Guardar</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
let solicitudesTec = JSON.parse(localStorage.getItem("tecnologiaLS") || "[]");
let seguimiento = JSON.parse(localStorage.getItem("seguimientoLS") || "[]");
let indexComentario = null;
let archivoActual = null;

let selectFolio = document.getElementById("folio");

function actualizarSelectorFolios(){
    selectFolio.innerHTML = "<option value=''>Seleccione un folio</option>";
    solicitudesTec.forEach(s => {
        // Solo agregar folios que no est√©n en seguimiento
        let yaRegistrado = seguimiento.some(seg => seg.folio === s.folio);
        if(!yaRegistrado){
            selectFolio.innerHTML += `<option value="${s.folio}">${s.folio}</option>`;
        }
    });
}

// Inicializar selector
actualizarSelectorFolios();

selectFolio.addEventListener("change", ()=> {
    let fol = selectFolio.value;
    let data = solicitudesTec.find(s => s.folio === fol);
    if(data){
        solicito.value = data.soporte;
        sucursal.value = data.sucursal;
        archivoActual = data.archivo || null;
        document.getElementById("btnArchivo").disabled = archivoActual ? false : true;
    }
});

function verArchivo(){
    if(!archivoActual){ alert("No hay archivo registrado."); return; }
    window.open(archivoActual, "_blank");
}

document.getElementById("fechaCompras").value = new Date().toLocaleString();

function guardarSeguimiento(){
    let fol = folio.value;
    if(!fol){ alert("Debe seleccionar un folio."); return; }

    let seg = {
        folio: fol,
        solicito: solicito.value,
        sucursal: sucursal.value,
        archivo: archivoActual,
        fechaCompras: fechaCompras.value,
        descripcion: descripcion.value.toUpperCase(),
        folioCot: folioCot.value.toUpperCase(),
        fechaCot: fechaCot.value,
        autoriza: autoriza.value.toUpperCase(),
        fechaAuto: fechaAuto.value,
        recibe: recibe.value.toUpperCase(),
        fechaEntrega: fechaEntrega.value,
        envia: envia.value.toUpperCase(),
        fechaEnvio: fechaEnvio.value,
        folioFactura: folioFactura.value.toUpperCase(),
        status: document.getElementById("status").value,
        comentarios: comentarios.value.toUpperCase(),
        extra: ""
    };

    seguimiento.push(seg);
    localStorage.setItem("seguimientoLS", JSON.stringify(seguimiento));

    actualizarTabla();
    actualizarSelectorFolios(); // Actualizar dropdown despu√©s de guardar
    formSeg.reset();
    document.getElementById("btnArchivo").disabled = true;
}

function aplicarColorStatus(texto){
    if(texto === "ENVIADO A COMPRAS") return "status-compras";
    if(texto === "ENVIADO A ZONA") return "status-zona";
    if(texto === "PENDIENTE POR AUTORIZAR") return "status-pendiente";
    if(texto === "EN SISTEMAS") return "status-sistemas";
    return "";
}

function actualizarTabla(){
    let t = document.getElementById("tablaSegBody");
    t.innerHTML = "";

    seguimiento.forEach((s, i) => {
        let claseStatus = aplicarColorStatus(s.status);

        t.innerHTML += `
        <tr>
            <td>${s.folio}</td>
            <td>${s.solicito}</td>
            <td>${s.descripcion}</td>
            <td>${s.folioCot}</td>
            <td class="${claseStatus} fw-bold">${s.status}</td>
            <td>${s.fechaCompras}</td>
            <td>
                <span class="action-btn text-primary" onclick="abrirComentario(${i})">üìù</span>
                <span class="action-btn text-danger" onclick="eliminarSeguimiento(${i})">üóëÔ∏è</span>
            </td>
        </tr>`;
    });
}

function abrirComentario(i){
    indexComentario = i;
    extraComentario.value = seguimiento[i].extra || "";
    new bootstrap.Modal(document.getElementById("modalComent")).show();
}

function guardarComentarioExtra(){
    seguimiento[indexComentario].extra = extraComentario.value.toUpperCase();
    localStorage.setItem("seguimientoLS", JSON.stringify(seguimiento));
    bootstrap.Modal.getInstance(document.getElementById("modalComent")).hide();
    actualizarTabla();
}

function eliminarSeguimiento(i){
    if(confirm("¬øDesea eliminar este seguimiento?")){
        seguimiento.splice(i, 1);
        localStorage.setItem("seguimientoLS", JSON.stringify(seguimiento));
        actualizarTabla();
        actualizarSelectorFolios(); // Permite volver a seleccionar el folio eliminado
    }
}

actualizarTabla();
</script>

</body>
</html>
