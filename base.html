<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Base - Registro de Personal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
.action-btn { cursor: pointer; margin-top: 10px; font-size: 20px; }
</style>
</head>
<body class="p-4 bg-light">

<h2 class="mb-4">Registro de Personal</h2>
<div class="card p-4 shadow">
<form id="formPersonal" class="row g-3">
  <div class="col-md-4">
    <label class="form-label">Empresa:</label>
    <select id="empresaSelect" class="form-select"></select>
    <button type="button" class="btn btn-sm btn-primary mt-1" onclick="agregarEmpresa()">Agregar Empresa</button>
  </div>

  <div class="col-md-4">
    <label class="form-label">Zona:</label>
    <select id="zonaSelect" class="form-select"></select>
    <button type="button" class="btn btn-sm btn-primary mt-1" onclick="agregarZona()">Agregar Zona</button>
  </div>

  <div class="col-md-4">
    <label class="form-label">Puesto:</label>
    <select id="puestoSelect" class="form-select"></select>
    <button type="button" class="btn btn-sm btn-primary mt-1" onclick="agregarPuesto()">Agregar Puesto</button>
  </div>

  <div class="col-md-6">
    <label class="form-label">Nombre Completo:</label>
    <input id="nombre" class="form-control" oninput="this.value=this.value.toUpperCase()">
  </div>

  <div class="col-md-6">
    <label class="form-label">Correo:</label>
    <input id="correo" type="email" class="form-control">
  </div>

  <div class="col-md-6">
    <label class="form-label">Usuario:</label>
    <input id="usuario" class="form-control" oninput="this.value=this.value.toUpperCase()">
  </div>

  <div class="col-md-6">
    <label class="form-label">Contrase√±a:</label>
    <input id="contrasena" type="password" class="form-control">
  </div>

  <div class="col-12 d-flex align-items-center">
    <button type="button" class="btn btn-success me-2" onclick="guardarPersonal()">Guardar Registro</button>
    <button type="button" class="btn btn-secondary" onclick="irLogin()">üîô Regresar al Login</button>
  </div>
</form>
</div>

<h2 class="mt-5">Tabla de Personal</h2>
<table class="table table-bordered table-striped mt-3">
<thead class="table-dark">
<tr>
<th>Empresa</th><th>Zona</th><th>Nombre</th><th>Correo</th><th>Puesto</th><th>Usuario</th><th>Contrase√±a</th>
<th>Status</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

<!-- MODAL EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>Editar Registro</h5></div>
      <div class="modal-body">
        <input id="editNombre" class="form-control mb-2">
        <input id="editCorreo" class="form-control mb-2">
        <input id="editUsuario" class="form-control mb-2">
        <input id="editContrasena" class="form-control mb-2" type="password">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="guardarEdicion()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
function irLogin(){
  window.location.href = "login.html";
}

let empresas = JSON.parse(localStorage.getItem("empresas")) || ["PINGOL","P57","PUMO","PINPJ","ACF","FERREPRECIOS"];
let zonas = JSON.parse(localStorage.getItem("zonas")) || [
  "TULA","TIZAYUCA","TULANCINGO","PUEBLA (VILLA JUAREZ)","POZA RICA","VERACRUZ NORTE","HUASTECA","VALLES",
  "JOJUTLA","CUAUTLA","TEPIC","JALISCO","PUEBLA","CD JUAREZ","CDMX","TULANCIINGO","CENTRO","NORTE","SUR","GUERRERO","MAYOREO"
];
let puestos = JSON.parse(localStorage.getItem("puestos")) || ["Gerente de Sistemas","Jefe de Infra Estructura","Coordinador de Soporte Tecnico","Soporte Tecnico","Becario Sistemas"];
let personal = JSON.parse(localStorage.getItem("personal")) || [];

let indexEditar = null;

function guardarLS(){
  localStorage.setItem("empresas", JSON.stringify(empresas));
  localStorage.setItem("zonas", JSON.stringify(zonas));
  localStorage.setItem("puestos", JSON.stringify(puestos));
  localStorage.setItem("personal", JSON.stringify(personal));
}

function cargarSelect(id, data){
  let sel = document.getElementById(id);
  sel.innerHTML = "";
  data.forEach(v=>{ let o=document.createElement("option"); o.textContent=o.value=v; sel.appendChild(o); });
}
function cargarTodo(){ 
  cargarSelect("empresaSelect", empresas); 
  cargarSelect("zonaSelect", zonas); 
  cargarSelect("puestoSelect", puestos); 
  actualizarTabla(); 
}

function agregarEmpresa(){ let e=prompt("Nueva Empresa:"); if(e){ empresas.push(e.toUpperCase()); guardarLS(); cargarTodo(); }}
function agregarZona(){ let e=prompt("Nueva Zona:"); if(e){ zonas.push(e.toUpperCase()); guardarLS(); cargarTodo(); }}
function agregarPuesto(){ let e=prompt("Nuevo Puesto:"); if(e){ puestos.push(e); guardarLS(); cargarTodo(); }}

function validarCorreo(c){ return c.includes("@"); }
function validarContrasena(c){ return /[A-Za-z]/.test(c)&&/[0-9]/.test(c)&&/[^A-Za-z0-9]/.test(c); }

function guardarPersonal(){
  let data={
    empresa:empresaSelect.value,
    zona:zonaSelect.value,
    nombre:nombre.value.toUpperCase(),
    correo:correo.value,
    puesto:puestoSelect.value,
    usuario:usuario.value.toUpperCase(),
    contrasena:contrasena.value,
    bloqueado:false
  };

  if(!validarCorreo(data.correo)){ alert("Correo inv√°lido"); return; }
  if(!validarContrasena(data.contrasena)){ alert("Contrase√±a insegura"); return; }

  personal.push(data);
  guardarLS();
  actualizarTabla();
}

function actualizarTabla(){
  let t=document.getElementById("tablaBody");
  t.innerHTML="";
  personal.forEach((p,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.empresa}</td>
      <td>${p.zona}</td>
      <td>${p.nombre}</td>
      <td>${p.correo}</td>
      <td>${p.puesto}</td>
      <td>${p.usuario}${p.bloqueado?" (BLOQ)":""}</td>
      <td>${p.contrasena}</td>
      <td>${p.bloqueado ? "Inactivo" : "Activo"}</td>
      <td>
        <span class='action-btn' onclick='bloquear(${i})'>${p.bloqueado ? "üîì" : "üîí"}</span>
        <span class='action-btn' onclick='abrirEditar(${i})'>‚úèÔ∏è</span>
        <span class='action-btn' onclick='eliminar(${i})'>üóëÔ∏è</span>
      </td>`;
    t.appendChild(tr);
  });
}

function bloquear(i){
  if (personal[i].bloqueado) {
    personal[i].bloqueado = false;
    personal[i].contrasena = prompt("Ingresa nueva contrase√±a para desbloquear al usuario:");
    if (!personal[i].contrasena || personal[i].contrasena.trim() === "") { alert("Debe ingresar una contrase√±a v√°lida."); return; }
  } 
  else {
    personal[i].bloqueado = true;
    personal[i].contrasena = "--BLOQUEADO--";
  }
  guardarLS();
  actualizarTabla();
}

function eliminar(i){ personal.splice(i,1); guardarLS(); actualizarTabla(); }

function abrirEditar(i){
  indexEditar=i;
  editNombre.value=personal[i].nombre;
  editCorreo.value=personal[i].correo;
  editUsuario.value=personal[i].usuario;
  editContrasena.value=personal[i].contrasena;
  new bootstrap.Modal(document.getElementById('modalEditar')).show();
}

function guardarEdicion(){
  let p=personal[indexEditar];
  p.nombre=editNombre.value.toUpperCase();
  p.correo=editCorreo.value;
  p.usuario=editUsuario.value.toUpperCase();
  p.contrasena=editContrasena.value;
  guardarLS(); 
  actualizarTabla();
  bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
}

cargarTodo();
</script>

</body>
</html>
